<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PJM Forecast Convergence</title>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
      #chart { width: 100%; height: 70vh; }
      .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      .badge { padding: 6px 10px; border: 1px solid #ddd; border-radius: 999px; }
    </style>
  </head>
  <body>
    <div class="row">
      <h2 style="margin:0;">Forecast Convergence (48h)</h2>
      <div class="badge" id="status">Loadingâ€¦</div>
    </div>
    <div id="chart"></div>

    <script>
      const area = "RTO_COMBINED";
      const sinceHours = 12; // change to 24 for more lines (48 runs/day)

      function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

      async function load() {
        const latest = await (await fetch(`/api/latest?area=${encodeURIComponent(area)}`)).json();
        document.getElementById("status").textContent =
          latest?.run_ts ? `Last ingest: ${latest.run_ts}` : "No data yet";

        const data = await (await fetch(`/api/runs?area=${encodeURIComponent(area)}&since_hours=${sinceHours}`)).json();
        const runs = data.runs || [];
        if (!runs.length) return;

        const now = new Date();
        const traces = runs.map((r, i) => {
          const runTs = new Date(r.run_ts);
          const ageMin = (now - runTs) / 60000;
          const opacity = clamp(1 - ageMin / (sinceHours * 60), 0.05, 1.0);
          return {
            x: r.points.map(p => p.target_ts),
            y: r.points.map(p => p.mw),
            type: "scatter",
            mode: "lines",
            name: r.run_ts,
            opacity
          };
        });

        Plotly.newPlot("chart", traces, {
          margin: {l: 50, r: 20, t: 20, b: 40},
          xaxis: {title: "Target hour"},
          yaxis: {title: "MW"},
          legend: {orientation: "h"}
        }, {displayModeBar: false, responsive: true});
      }

      load();
      setInterval(load, 60_000); // refresh chart every minute
    </script>
  </body>
</html>

