<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PJM Load Forecast Convergence</title>

    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 16px;
      }
      #chart {
        width: 100%;
        height: 75vh;
      }
      .row {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      .badge {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 999px;
        font-size: 14px;
      }
      .hint {
        color: #666;
        font-size: 13px;
        margin-top: 6px;
      }
    </style>
  </head>

  <body>
    <div class="row">
      <h2 style="margin: 0;">PJM Load Forecast Convergence</h2>
      <div class="badge" id="status">Loading…</div>
    </div>
    <div class="hint">
      Latest forecast is red. Older runs fade aggressively. Times shown in ET.
    </div>

    <div id="chart"></div>

    <script>
      const AREA = "RTO_COMBINED";
      const SINCE_HOURS = 12;
      const TIMEZONE = "America/New_York";

      const COLOR_LATEST = "#d62728"; // red
      const COLOR_OLD = "#1f77b4";    // blue

      function clamp(v, lo, hi) {
        return Math.max(lo, Math.min(hi, v));
      }

      function toETDate(utcIso) {
        const d = new Date(utcIso);
        return new Date(d.toLocaleString("en-US", { timeZone: TIMEZONE }));
      }

      function nowETDate() {
        return new Date(new Date().toLocaleString("en-US", { timeZone: TIMEZONE }));
      }

      async function load() {
        // ---- latest run badge ----
        const latestResp = await fetch(`/api/latest?area=${encodeURIComponent(AREA)}`);
        const latest = await latestResp.json();
        document.getElementById("status").textContent =
          latest && latest.run_ts ? `Last ingest: ${latest.run_ts}` : "No data yet";

        // ---- runs ----
        const runsResp = await fetch(
          `/api/runs?area=${encodeURIComponent(AREA)}&since_hours=${encodeURIComponent(SINCE_HOURS)}`
        );
        const data = await runsResp.json();
        const runs = (data && data.runs) ? data.runs : [];
        if (!runs.length) return;

        const now = new Date();
        const maxAgeMin = SINCE_HOURS * 60;
        const newestMs = Math.max(...runs.map(r => new Date(r.run_ts).getTime()));

        const traces = [];

        runs.forEach((r) => {
          const runTs = new Date(r.run_ts);
          const ageMin = (now - runTs) / 60000;

          // 0 newest → 1 oldest
          const t = clamp(ageMin / maxAgeMin, 0, 1);

          // SUPER aggressive nonlinear fade
          // Recent = visible, old = basically gone
          const curve = Math.pow(1 - t, 4.0);

          const isLatest = runTs.getTime() === newestMs;

          traces.push({
            x: r.points.map(p => toETDate(p.target_ts)),
            y: r.points.map(p => p.mw),
            type: "scatter",
            mode: "lines",
            line: {
              color: isLatest ? COLOR_LATEST : COLOR_OLD,
              width: isLatest ? 2.4 : 0.8
            },
            opacity: isLatest ? 1.0 : (0.005 + 0.25 * curve),
            hovertemplate: isLatest
              ? "Hour (ET): %{x}<br>MW: %{y:,.0f}<extra>Latest</extra>"
              : "Hour (ET): %{x}<br>MW: %{y:,.0f}<extra></extra>"
          });
        });

        const layout = {
          margin: { l: 60, r: 20, t: 20, b: 40 },
          xaxis: { title: "Hour (ET)" },
          yaxis: { title: "MW" },
          showlegend: false,
          shapes: []
        };

        Plotly.newPlot("chart", traces, layout, {
          displayModeBar: false,
          responsive: true
        });

        // ---- NOW (ET) ----
        const nowET = nowETDate();
        Plotly.relayout("chart", {
          shapes: [
            {
              type: "line",
              xref: "x",
              yref: "paper",
              x0: nowET,
              x1: nowET,
              y0: 0,
              y1: 1,
              line: { color: "#000", width: 1, dash: "dot" }
            }
          ]
        });
      }

      load();
      setInterval(load, 60_000);
    </script>
  </body>
</html>
