<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PJM Load Forecast Convergence</title>

    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 16px;
      }
      #chart {
        width: 100%;
        height: 75vh;
      }
      .row {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      .badge {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 999px;
        font-size: 14px;
      }
    </style>
  </head>

  <body>
    <div class="row">
      <h2 style="margin: 0;">PJM Load Forecast Convergence (48h)</h2>
      <div class="badge" id="status">Loadingâ€¦</div>
    </div>

    <div id="chart"></div>

    <script>
      const AREA = "RTO_COMBINED";
      const SINCE_HOURS = 12; // how many past runs to show
      const TIMEZONE = "America/New_York";

      function clamp(v, lo, hi) {
        return Math.max(lo, Math.min(hi, v));
      }

      function toETDate(utcIso) {
        const d = new Date(utcIso);
        return new Date(
          d.toLocaleString("en-US", { timeZone: TIMEZONE })
        );
      }

      async function load() {
        // ---- latest run badge ----
        const latestResp = await fetch(`/api/latest?area=${AREA}`);
        const latest = await latestResp.json();
        document.getElementById("status").textContent =
          latest?.run_ts ? `Last ingest: ${latest.run_ts}` : "No data yet";

        // ---- forecast runs ----
        const runsResp = await fetch(
          `/api/runs?area=${AREA}&since_hours=${SINCE_HOURS}`
        );
        const data = await runsResp.json();
        const runs = data.runs || [];
        if (!runs.length) return;

        const now = new Date();
        const traces = [];

        runs.forEach((r) => {
          const runTs = new Date(r.run_ts);
          const ageMinutes = (now - runTs) / 60000;
          const opacity = cl
